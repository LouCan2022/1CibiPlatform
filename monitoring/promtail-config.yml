server:
  http_listen_port: 9080     # Promtail metrics/health endpoint
  grpc_listen_port: 0        # Disable gRPC (not needed)

positions:
  filename: /tmp/positions.yaml   # Tracks how far Promtail has read logs

clients:
  - url: http://loki:3100/loki/api/v1/push
    batchsize: 1048576           # 1MB max per batch (reduce if you see 429s)
    batchwait: 2s                # Wait before sending batch
    backoff_config:              # Retry strategy to avoid hammering Loki
      min_period: 500ms
      max_period: 5s
      max_retries: 10

scrape_configs:
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock

    relabel_configs:
      # Container name label (stripped leading slash)
      - source_labels: [__meta_docker_container_name]
        regex: "/(.*)"
        target_label: container_name
    
      # Optional: Use container name as job label (stripped slash)
      - source_labels: [__meta_docker_container_name]
        regex: "/(.*)"
        target_label: job
    
      # Container ID label
      - source_labels: [__meta_docker_container_id]
        target_label: container_id
    
      # Path to logs inside Docker container runtime
      - source_labels: [__meta_docker_container_id]
        regex: (.+)
        target_label: __path__
        replacement: /var/lib/docker/containers/${1}/*-json.log



    pipeline_stages:
      # Parse Docker JSON logs
      - json:
          expressions:
            stream: stream
            log: log
            time: time

      # Use 'log' field as actual log line
      - output:
          source: log

      #  drop noisy healthcheck logs
      - drop:
          source: log
          expression: "GET /health"

      # : set severity label if structured logs exist
      - regex:
          expression: "(?i)(error|warn|info|debug)"
          source: log
      - labels:
          level:
