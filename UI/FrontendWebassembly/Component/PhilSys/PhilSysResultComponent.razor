@layout PhilSysLayout
@using MudBlazor
@inject IJSRuntime JS


<MudPaper Class="p-6 d-flex flex-wrap align-items-start gap-6 position-relative"
          Style="background-color: var(--mud-palette-surface); border-radius: 12px; padding: 20px 20px 60px 0px;">

    <div class="d-flex flex-column align-items-center" style="width: 220px;">
        <MudPaper Elevation="0"
                  Class="d-flex justify-center align-center mb-3"
                  Style="width: 200px; height: 200px; background-color: var(--mud-palette-background); border-radius: 12px;">
            <MudImage Src="@(FaceUrl ?? "images/generic/default_picture.jpg")"
                      Alt="User Profile"
                      Width="120" 
                      Style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px; outline: 2px solid black;" />
        </MudPaper>

        <ButtonComponent StartIcon="@Icons.Material.Filled.Download" Style="width: 170px;"
                         Class="theme-button theme-button-active">
            API Response
        </ButtonComponent>
    </div>

    <div class="flex-grow-1" style="min-width: 500px;">
        <table style="width: 100%; border-collapse: collapse;">
            @if (InfoRows != null)
            {
                @foreach (var row in InfoRows)
                {
                    <tr>
                        <td style="width: 25%; padding: 6px 8px; vertical-align: top; color: var(--mud-palette-text-primary);">
                            <MudText Typo="Typo.body1">@row.Label</MudText>
                        </td>
                        <td style="width: 25%; padding: 6px 8px;">
                            <MudText Style="color: var(--mud-palette-text-primary); font-weight: bold;" Typo="Typo.body1">
                               @row.Value
                            </MudText>
                        </td>
                    </tr>
                }
            }
        </table>
    </div>

    <div class="position-absolute" style="bottom: 16px; right: 16px;">
        <ButtonComponent StartIcon="@Icons.Material.Filled.Search"
                         Class="theme-button theme-button-active"
                         OnClick="DownloadApiResponse">
            Search Again
        </ButtonComponent>
    </div>
</MudPaper>

@code {
    [Parameter]
    public UpdateFaceLivenessSessionResponseDTO? VerificationResult { get; set; }

    private List<(string Label, string Value)>? InfoRows;


    private string? FaceUrl;
  
    private async Task DownloadApiResponse()
    {
        if (VerificationResult == null)
            return;

        var json = System.Text.Json.JsonSerializer.Serialize(
            VerificationResult,
            new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true // nicely formatted JSON
            });

        var fileName = $"ApiResponse_{DateTime.Now:yyyyMMdd_HHmmss}.json";

        // Call the JS interop helper to trigger the download
        await JS.InvokeVoidAsync("downloadFileFromBlazor", fileName, "application/json", json);
    }


    protected override void OnInitialized()
    {
        if (VerificationResult == null)
        {
            InfoRows = new List<(string, string)>
        {
            ("Error", "No data available")
        };
            return;
        }
        FaceUrl = VerificationResult.face_url;
        InfoRows = new()
        {
            ("PhilSys Card Number", VerificationResult.reference ?? "No Data Found"),
            ("Digital ID Number", VerificationResult.code ?? "No Data Found"),
            ("First Name", VerificationResult.first_name ?? "No Data Found"),
            ("Middle Name", VerificationResult.middle_name ?? "No Data Found"),
            ("Last Name", VerificationResult.last_name ?? "No Data Found"),
            ("Suffix", string.IsNullOrWhiteSpace(VerificationResult.suffix)
                       ? (!string.IsNullOrWhiteSpace(VerificationResult.reference) ? "" : "No Data Found")
                       : VerificationResult.suffix),
            ("Gender", VerificationResult.gender ?? "No Data Found"),
            ("Birth Date", VerificationResult.birth_date ?? "No Data Found"),
            ("Place of Birth", VerificationResult.place_of_birth ?? "No Data Found"),
            ("Permanent Address", VerificationResult.full_address ?? "No Data Found"),
            ("Present Address", VerificationResult.present_full_address ?? "No Data Found"),
            ("Marital Status", VerificationResult.marital_status ?? "No Data Found"),
            ("Mobile Number", VerificationResult.mobile_number ?? "No Data Found"),
            ("Email", VerificationResult.email ?? "No Data Found"),
            ("Blood Type", VerificationResult.blood_type ?? "No Data Found")
        };

}
}
