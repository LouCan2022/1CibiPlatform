@inject LocalStorageService LocalStorageService
@inject IUserManagementService UserManagementService

<MudDialog Style="padding: 8px;">
    <DialogContent>

        @if (!IsLoaded)
        {
            <div style="display: flex; justify-content: center; align-items: center; height: 200px;">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            </div>
        }
        else
        {
            <MudForm @ref="form">

                <MudSelect @bind-Value="AppSubRole.UserId"
                           Label="Email"
                           Required="true"
                           Placeholder="Select a user...">
                    @foreach (var user in Users!)
                    {
                        <MudSelectItem Value="@user.userId">@user.email</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="AppSubRole.AppId"
                           Label="Application"
                           Required="true"
                           Placeholder="Select an application...">
                    @foreach (var app in Apps!)
                    {
                        <MudSelectItem Value="@app.applicationId">@app.applicationName</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="AppSubRole.SubMenuId"
                           Label="Submenu"
                           Required="true"
                           Placeholder="Select a submenu...">
                    @foreach (var sm in SubMenus!)
                    {
                        <MudSelectItem Value="@sm.subMenuId">@sm.subMenuName</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="AppSubRole.RoleId"
                           Label="Role"
                           Required="true"
                           Placeholder="Select a role...">
                    @foreach (var role in Roles!)
                    {
                        <MudSelectItem Value="@role.roleId">@role.roleName</MudSelectItem>
                    }
                </MudSelect>

            </MudForm>
        }

    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Default"
                   OnClick="Cancel"
                   Style="border-radius: 4px;">
            Cancel
        </MudButton>
        <MudButton Color="Color.Primary"
                   OnClick="Submit"
                   Class="theme-button theme-button-active"
                   Style="border-radius: 4px;">
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private MudForm? form;
    private bool IsLoaded = false;
    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public AppSubRolesDTO AppSubRole { get; set; } = new AppSubRolesDTO();

    private List<UsersDTO>? Users = new();
    private List<ApplicationsDTO>? Apps = new();
    private List<SubMenusDTO>? SubMenus = new();
    private List<RolesDTO>? Roles = new();

    void Cancel() => MudDialog!.Cancel();

    protected override async Task OnInitializedAsync()
    {
        Users = (await UserManagementService.GetUsersAsync(1, int.MaxValue)).Data.ToList();
        Apps = (await UserManagementService.GetApplicationsAsync(1, int.MaxValue)).Data.ToList();
        SubMenus = (await UserManagementService.GetSubMenusAsync(1, int.MaxValue)).Data.ToList();
        Roles = (await UserManagementService.GetRolesAsync(1, int.MaxValue)).Data.ToList();

        IsLoaded = true;
    }

    async Task Submit()
    {
        await form!.Validate();
        if (form.IsValid)
        {
            MudDialog!.Close(DialogResult.Ok(AppSubRole));
        }
    }
}