@page "/philsys/idv"
@inject NavigationManager Navigation
@inject IPhilSysService PhilSysService
@using MudBlazor
@using System.Text.RegularExpressions
@using FrontendWebassembly.Component.Special
@using FrontendWebassembly.Services.Auth.Shared
@inherits SecurePageBase
@* philsys/idv *@
@attribute [RequirePermission(2, 2)]

<MudGrid Justify="Justify.Center">
    <MudItem xs="12" sm="10" md="8" lg="6">

        <MudPaper Elevation="1" Class="p-4 philsys-form-container" Style="border-radius: 10px;  border: 1px solid gray; max-width: 530px;">

            <MudTabs Rounded="true"
                     Centered="true"
                     Elevation="0"
                     ScrollButtons="false"
                     OverflowBehavior="Scroll"
                     @bind-ActivePanelIndex="_activeIndex"
                     OnActivePanelIndexChanged="OnTabChanged"
                     Class="philsys-custom-tabs mb-3">
                <MudTabPanel Text="Personal Information" Class="@GetTabClass(0)" Style="text-transform:none; font-size: 18px;" />
                <MudTabPanel Text="PhilSys Card Number" Class="@GetTabClass(1)" Style="text-transform:none; font-size: 18px;" />
            </MudTabs>

            @if (_activeIndex == 0)
            {
                <MudForm @ref="personalForm" >

                    <MudGrid Class="mb-2" Spacing="2">
                        <MudItem xs="12" sm="8">
                            <MudTextField @bind-Value="identityData!.first_name"
                                          Label="First Name"
                                          FullWidth="true"
                                          Required="true"
                                          RequiredError="First Name is required"
                                          Adornment="Adornment.Start"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Class="philsys-rounded-input" />
                        </MudItem>

                        <MudItem xs="12" sm="4">
                            <MudSelect @bind-Value="identityData!.suffix"
                                       Label="Suffix"
                                       FullWidth="true"
                                       Adornment="Adornment.Start"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Class="philsys-rounded-input">
                                <MudSelectItem Value=@("")>N/A</MudSelectItem>
                                <MudSelectItem Value=@("Jr.")>Jr.</MudSelectItem>
                                <MudSelectItem Value=@("Sr.")>Sr.</MudSelectItem>
                                <MudSelectItem Value=@("II.")>II.</MudSelectItem>
                                <MudSelectItem Value=@("III.")>III.</MudSelectItem>
                                <MudSelectItem Value=@("IV.")>IV.</MudSelectItem>
                                <MudSelectItem Value=@("V.")>V.</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudGrid Spacing="2">
                        <MudItem xs="12">
                            <MudTextField @bind-Value="identityData!.middle_name"
                                          Label="Middle Name"
                                          Required="true"
                                          RequiredError="Middle Name is required"
                                          FullWidth="true"
                                          Adornment="Adornment.Start"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Class="philsys-rounded-input" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField @bind-Value="identityData!.last_name"
                                          Label="Last Name"
                                          Required="true"
                                          FullWidth="true"
                                          RequiredError="Last Name is required"
                                          Adornment="Adornment.Start"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Class="philsys-rounded-input" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField @bind-Value="identityData!.birth_date"
                                          Label="Birth Date"
                                          InputType="InputType.Date"
                                          FullWidth="true"
                                          Required="true"
                                          RequiredError="Birth Date is required"
                                          Adornment="Adornment.Start"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Min="1900-01-01"
                                          Max="@DateTime.Today.ToString("yyyy-MM-dd")"
                                          Class="philsys-rounded-input" />
                        </MudItem>
                    </MudGrid>

                    <ButtonComponent OnClick="SubmitPersonalInfo"
                                     Class="theme-button theme-button-active mt-4"
                                     Style="border-radius: 4px;">
                        Next
                    </ButtonComponent>
                </MudForm>
            }
            else if (_activeIndex == 1)
            {
                <MudForm @ref="pcnForm">

                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="identityData!.pcn"
                                          Label="PhilSys Card Number (16-Digits)"
                                          Required="true"
                                          FullWidth="true"
                                          RequiredError="PhilSys Card Number is required"
                                          Adornment="Adornment.Start"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Class="philsys-rounded-input" />
                        </MudItem>
                    </MudGrid>

                    <ButtonComponent OnClick="SubmitPCN"
                                     Class="theme-button theme-button-active mt-4"
                                     Style="border-radius: 4px;">
                        Next
                    </ButtonComponent>
                </MudForm>
            }

        </MudPaper>
    </MudItem>
</MudGrid>



@code {
    private MudForm? personalForm;
    private MudForm? pcnForm;
    private IdentityData? identityData;
    private string? Suffix { get; set; } = "N/A";
    private string? PCN { get; set; } = string.Empty;
    private int _activeIndex = 0;

    protected override void OnInitialized()
    {
        identityData = new IdentityData();
    }

    private async Task SubmitPersonalInfo()
    {
        await personalForm!.Validate();
        if (!personalForm.IsValid)
            return;
        
        var livenessLink = await PhilSysService.PostBasicInformationOrPCN("name_dob", identityData!);
        if (!string.IsNullOrEmpty(livenessLink))
        {
            Navigation.NavigateTo(livenessLink, forceLoad: true);
        }
    }

    private async Task SubmitPCN()
    {
        await pcnForm!.Validate();
        if (!pcnForm.IsValid)
            return;

        var livenessLink = await PhilSysService.PostBasicInformationOrPCN("pcn", identityData!);
        if (!string.IsNullOrEmpty(livenessLink))
        {
            Navigation.NavigateTo(livenessLink, forceLoad: true);
        }
    }
    private void OnTabChanged(int index)
    {
        _activeIndex = index;
    }

    private string GetTabClass(int index)
    {
        return _activeIndex == index
            ? "philsys-tab-pannel philsys-tab-pannel-active"
            : "philsys-tab-pannel philsys-tab-pannel-inactive";
    }

    private string? ValidatePCN(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "PhilSys Card Number is required";

        if (!Regex.IsMatch(value, @"^\d{16}$"))
            return "PhilSys Card Number must be exactly 16 digits";

        return null;
    }
}
