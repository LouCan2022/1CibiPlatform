@page "/settings/usermanagement"
@layout MainLayout
@inject IUserManagementService UserManagementService
@inject IDialogService DialogService
@inherits SecurePageBase
@inject IConfiguration Configuration
@attribute [RequirePermission(3, 3)]

<MudTabs Rounded="false"
                 Scrollable="true"
                 Centered="true"
                 Elevation="0"
                 AlwaysShowScrollButtons="true"
                 @bind-ActivePanelIndex="_activeIndex"
                 OnActivePanelIndexChanged="OnTabChanged"
                 Class="philsys-custom-tabs mb-5">
                <MudTabPanel Text="Locked User" Class="@GetTabClass(0)" Style="text-transform:none; min-width:120px;" />
                <MudTabPanel Text="Approval" Class="@GetTabClass(1)" Style="text-transform:none; min-width:120px;" />
                <MudTabPanel Text="User" Class="@GetTabClass(2)" Style="text-transform:none; min-width:120px;" />
                <MudTabPanel Text="Appplication" Class="@GetTabClass(3)"  Style="text-transform:none; min-width: 120px;" />
                <MudTabPanel Text="SubMenu" Class="@GetTabClass(4)" Style="text-transform:none; min-width: 120px;" />
                <MudTabPanel Text="Role" Class="@GetTabClass(5)" Style="text-transform:none; min-width: 120px;" />
                <MudTabPanel Text="User's AppSubRole" Class="@GetTabClass(6)" Style="text-transform:none; min-width: 120px;" />
</MudTabs>
@if (_activeIndex == 0)
{
    <TableComponent TItem="LockedUsersDTO"
                    @ref="lockedUsersTable"
                    Title="Locked User/s"
                    EnableSearch="true"
                    LoadServerData="LoadLockedUsersServerData"
                    SearchString="@searchStringLockedUser"
                    ColumnCount="3"
                    SearchStringChanged="@((string val) => searchStringLockedUser = val)">
        <HeaderTemplate>
            <MudTh>Email</MudTh>
            <MudTh>Locked At</MudTh>
            <MudTh>Lock Release At</MudTh>
            <MudTh>Unlock</MudTh>
        </HeaderTemplate>

        <RowTemplate Context="lockeduser">
            <MudTd DataLabel="Email">@lockeduser.Email</MudTd>
            <MudTd DataLabel="Locked At">@lockeduser.CreatedAt</MudTd>
            <MudTd DataLabel="Locked Release At">@lockeduser.LockReleaseAt</MudTd>
            <MudTd DataLabel="Unlock">
                <MudIconButton Icon="@Icons.Material.Filled.LockOpen" Color="Color.Error" Size="Size.Medium"
                               OnClick="@(() => ConfirmUnlockAccount(lockeduser.UserId))"></MudIconButton>
            </MudTd>
        </RowTemplate>
    </TableComponent>
}
else if (_activeIndex == 1)
{
    <TableComponent TItem="UnApprovedUsersDTO"
                    @ref="unapprovedUsersTable"
                    Title="User Approval"
                    EnableSearch="true"
                    LoadServerData="LoadUnApprovedUsersServerData"
                    SearchString="@searchStringUnApprovedUser"
                    ColumnCount="4"
                    SearchStringChanged="@((string val) => searchStringUnApprovedUser = val)">
        <HeaderTemplate>
            <MudTh>Email</MudTh>
            <MudTh>Action</MudTh>
        </HeaderTemplate>

        <RowTemplate Context="unapproveduser">
            <MudTd DataLabel="Email">@unapproveduser.email</MudTd>
            <MudTd DataLabel="Action">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Medium"
                               OnClick="@(() => OpenEditUserApprovalDialog(unapproveduser))" />
            </MudTd>
        </RowTemplate>
    </TableComponent>
}
else if (_activeIndex == 2)
{
    <TableComponent TItem="UsersDTO"
                    @ref="usersTable"
                    Title="User Management"
                    EnableSearch="true"
                    LoadServerData="LoadUsersServerData"
                    SearchString="@searchStringUser"
                    ColumnCount="4"
                    SearchStringChanged="@((string val) => searchStringUser = val)">
        <HeaderTemplate>
            <MudTh>Email</MudTh>
            <MudTh>First Name</MudTh>
            <MudTh>Middle Name</MudTh>
            <MudTh>Last Name</MudTh>
        </HeaderTemplate>

        <RowTemplate Context="user">
            <MudTd DataLabel="Email">@user.email</MudTd>
            <MudTd DataLabel="First Name">@user.firstName</MudTd>
            <MudTd DataLabel="Middle Name">@user.middleName</MudTd>
            <MudTd DataLabel="Last Name">@user.lastName</MudTd>
        </RowTemplate>
    </TableComponent>
}

else if (_activeIndex == 3)
{
    <TableComponent TItem="ApplicationsDTO"
                    @ref="applicationsTable"
                    Title="Application Management"
                    EnableSearch="true"
                    AddButtonText="Add"
                    OnAddClicked="OpenAddApplicationDialog"
                    LoadServerData="LoadApplicationsServerData"
                    SearchString="@searchStringApp"
                    ColumnCount="4"
                    SearchStringChanged="@((string val) => searchStringApp = val)">

        <HeaderTemplate>
            <MudTh>Id</MudTh>
            <MudTh>Application</MudTh>
            <MudTh>Description</MudTh>
            <MudTh>Action</MudTh>
        </HeaderTemplate>

        <RowTemplate Context="app">
            <MudTd DataLabel="Id">@app.applicationId</MudTd>
            <MudTd DataLabel="Application">@app.applicationName</MudTd>
            <MudTd DataLabel="Description">@app.Description</MudTd>
            <MudTd DataLabel="Action">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Medium"
                                   OnClick="@(() => OpenEditApplicationDialog(app))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Medium"
                                   OnClick="@(() => ConfirmDelete(app.applicationId, "application"))" />
            </MudTd>
        </RowTemplate>
    </TableComponent>
}

else if (_activeIndex == 4)
{
    <TableComponent TItem="SubMenusDTO"
                    @ref="subMenusTable"
                    Title="SubMenu Management"
                    EnableSearch="true"
                    AddButtonText="Add"
                    OnAddClicked="OpenAddSubMenuDialog"
                    LoadServerData="LoadSubMenusServerData"
                    SearchString="@searchStringSub"
                    ColumnCount="4"
                    SearchStringChanged="@((string val) => searchStringSub = val)">
              
        <HeaderTemplate>
            <MudTh>Id</MudTh>
            <MudTh>SubMenu</MudTh>
            <MudTh>Description</MudTh>
            <MudTh>Action</MudTh>
        </HeaderTemplate>

        <RowTemplate Context="sub">
            <MudTd DataLabel="Id">@sub.subMenuId</MudTd>
            <MudTd DataLabel="SubMenu">@sub.subMenuName</MudTd>
            <MudTd DataLabel="Description">@sub.Description</MudTd>
            <MudTd DataLabel="Action">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                               Color="Color.Primary" 
                               Size="Size.Medium" 
                               OnClick="@(() => OpenEditSubMenuDialog(sub))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                               Color="Color.Error" 
                               Size="Size.Medium" 
                               OnClick="@(() => ConfirmDelete(sub.subMenuId, "submenu"))" />
            </MudTd>
        </RowTemplate>
    </TableComponent>
}

else if (_activeIndex == 5)
{
    <TableComponent TItem="RolesDTO"
                    @ref="rolesTable"
                    Title="Role Management"
                    EnableSearch="true"
                    AddButtonText="Add"
                    OnAddClicked="OpenAddRoleDialog"
                    LoadServerData="LoadRolesServerData"
                    SearchString="@searchStringRole"
                    ColumnCount="4"
                    SearchStringChanged="@((string val) => searchStringRole = val)">

        <HeaderTemplate>
            <MudTh>Id</MudTh>
            <MudTh>Role</MudTh>
            <MudTh>Description</MudTh>
            <MudTh>Action</MudTh>
        </HeaderTemplate>

        <RowTemplate Context="role">
            <MudTd DataLabel="Id">@role.roleId</MudTd>
            <MudTd DataLabel="Role">@role.roleName</MudTd>
            <MudTd DataLabel="Description">@role.Description</MudTd>
            <MudTd DataLabel="Action">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                               Color="Color.Primary" 
                               Size="Size.Medium" 
                               OnClick="@(() => OpenEditRoleDialog(role))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                               Color="Color.Error" 
                               Size="Size.Medium" 
                               OnClick="@(() => ConfirmDelete(role.roleId, "role"))" />
            </MudTd>
        </RowTemplate>
    </TableComponent>
}

else if (_activeIndex == 6)
{
    <TableComponent TItem="AppSubRolesDTO"
                    @ref="appSubRolesTable"
                    Title="Users' AppSubRole Management"
                    EnableSearch="true"
                    AddButtonText="Add"
                    OnAddClicked="OpenAddAppSubRoleDialog"
                    LoadServerData="LoadUserAppSubRolesServerData"
                    SearchString="@searchStringAppSubRole"
                    ColumnCount="5"
                    SearchStringChanged="@((string val) => searchStringAppSubRole = val)">

        <HeaderTemplate>
            <MudTh>Email</MudTh>
            <MudTh>Application</MudTh>
            <MudTh>SubMenu</MudTh>
            <MudTh>Role</MudTh>
            <MudTh>Action</MudTh>
        </HeaderTemplate>

        <RowTemplate Context="appSubRole">
            <MudTd DataLabel="Email">@appSubRole.UserEmail</MudTd>
            <MudTd DataLabel="Application">@appSubRole.AppName</MudTd>
            <MudTd DataLabel="SubMenu">@appSubRole.SubMenuName</MudTd>
            <MudTd DataLabel="Role">@appSubRole.RoleName</MudTd>
            <MudTd DataLabel="Action">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                               Color="Color.Primary" 
                               Size="Size.Medium" 
                               OnClick="@(() => OpenEditAppSubRoleDialog(appSubRole))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                               Color="Color.Error" 
                               Size="Size.Medium" 
                               OnClick="@(() => ConfirmDelete(appSubRole.AppRoleId, "appsubrole"))" />
            </MudTd>
        </RowTemplate>
    </TableComponent>
}

@code {
    private int _activeIndex = 0;
    private string _searchStringUnApprovedUser;
    private string _searchStringLockedUser;
    private string _searchStringUser;
    private string _searchStringApp;
    private string _searchStringSub;
    private string _searchStringRole;
    private string _searchStringAppSubRole;
    private TableComponent<UnApprovedUsersDTO> unapprovedUsersTable;
    private TableComponent<LockedUsersDTO> lockedUsersTable;
    private TableComponent<UsersDTO> usersTable;
    private TableComponent<ApplicationsDTO> applicationsTable;
    private TableComponent<SubMenusDTO> subMenusTable;
    private TableComponent<RolesDTO> rolesTable;
    private TableComponent<AppSubRolesDTO> appSubRolesTable;
    private int _accountLockDuration;

    protected override void OnInitialized()
    {
        _accountLockDuration = Configuration.GetValue<int>("AuthWeb:AccountLockDurationInMinutes");
    }

    private void OnTabChanged(int index)
    {
        _activeIndex = index;
    }

    private string GetTabClass(int index)
    {
        return _activeIndex == index
            ? "philsys-tab-pannel philsys-tab-pannel-active"
            : "philsys-tab-pannel philsys-tab-pannel-inactive";
    }

    // Generic Functions
    private void UpdateSearch<T>(ref string field, string value, TableComponent<T> table) where T : class
    {
        if (field != value)
        {
            field = value;
            table?.TableRef.ReloadServerData();
        }
    }

    private async Task OpenAddDialog<TComponent, TDto>(string title, Func<TDto, Task> onAdd)
    where TComponent : ComponentBase
    {
        var options = new DialogOptions
        {
            CloseButton = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<TComponent>(title, options);
        var result = await dialog.Result;

        if (result?.Data is TDto dto)
        {
            await onAdd(dto);
        }
    }

    private async Task OpenEditDialog<TComponent, TDto>(string title, string paramName, TDto dto, Func<TDto, Task> onEdit)
    where TComponent : ComponentBase
    {
        var options = new DialogOptions
        {
            CloseButton = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var parameters = new DialogParameters
        {
            { paramName, dto }
        };

        var dialog = await DialogService.ShowAsync<TComponent>(title, parameters, options);
        var result = await dialog.Result;

        if (result?.Data is TDto editedDto)
        {
            await onEdit(editedDto);
        }
    }

    // Search 
    private string searchStringUnApprovedUser
    {
        get => _searchStringUnApprovedUser;
        set => UpdateSearch(ref _searchStringUnApprovedUser, value, unapprovedUsersTable);
    }

    private string searchStringLockedUser
    {
        get => _searchStringLockedUser;
        set => UpdateSearch(ref _searchStringLockedUser, value, lockedUsersTable);
    }

    private string searchStringUser
    {
        get => _searchStringUser;
        set => UpdateSearch(ref _searchStringUser, value, usersTable);
    }

    private string searchStringApp
    {
        get => _searchStringApp;
        set => UpdateSearch(ref _searchStringApp, value, applicationsTable);
    }

    private string searchStringSub
    {
        get => _searchStringSub;
        set => UpdateSearch(ref _searchStringSub, value, subMenusTable);
    }

    private string searchStringRole
    {
        get => _searchStringRole;
        set => UpdateSearch(ref _searchStringRole, value, rolesTable);
    }

    private string searchStringAppSubRole
    {
        get => _searchStringAppSubRole;
        set => UpdateSearch(ref _searchStringAppSubRole, value, appSubRolesTable);
    }

    // Load Tables
    private async Task<TableData<UsersDTO>> LoadUsersServerData(TableState state, CancellationToken cancellationToken)
    {
        var result = await UserManagementService.GetUsersAsync(
            state.Page + 1,
            state.PageSize,
            searchStringUser
        );
        return new TableData<UsersDTO>
        {
            TotalItems = (int)result.Count,
            Items = result.Data
        };
    }

    private async Task<TableData<UnApprovedUsersDTO>> LoadUnApprovedUsersServerData(TableState state, CancellationToken cancellationToken)
    {
        var result = await UserManagementService.GetUnApprovedUsersAsync(
            state.Page + 1,
            state.PageSize,
            searchStringUnApprovedUser
        );
        return new TableData<UnApprovedUsersDTO>
        {
            TotalItems = (int)result.Count,
            Items = result.Data
        };
    }

    private async Task<TableData<LockedUsersDTO>> LoadLockedUsersServerData(TableState state, CancellationToken cancellationToken)
    {
        var result = await UserManagementService.GetLockedUsersAsync(
            state.Page + 1,
            state.PageSize,
            searchStringUnApprovedUser
        );
        return new TableData<LockedUsersDTO>
        {
            TotalItems = (int)result.Count,
            Items = result.Data
        };
    }

    private async Task<TableData<ApplicationsDTO>> LoadApplicationsServerData(TableState state, CancellationToken cancellationToken)
    {
        var result = await UserManagementService.GetApplicationsAsync(
            state.Page + 1,
            state.PageSize,
            searchStringApp
        );

        return new TableData<ApplicationsDTO>
        {
            TotalItems = (int)result.Count,
            Items = result.Data
        };
    }

    private async Task<TableData<SubMenusDTO>> LoadSubMenusServerData(TableState state, CancellationToken cancellationToken)
    {
        var result = await UserManagementService.GetSubMenusAsync(
            state.Page + 1,
            state.PageSize,
            searchStringSub
        );

        return new TableData<SubMenusDTO>
        {
            TotalItems = (int)result.Count,
            Items = result.Data
        };
    }

    private async Task<TableData<RolesDTO>> LoadRolesServerData(TableState state, CancellationToken cancellationToken)
    {
        var result = await UserManagementService.GetRolesAsync(
            state.Page + 1,
            state.PageSize,
            searchStringRole
        );
        return new TableData<RolesDTO>
        {
            TotalItems = (int)result.Count,
            Items = result.Data
        };
    }

    private async Task<TableData<AppSubRolesDTO>> LoadUserAppSubRolesServerData(TableState state, CancellationToken cancellationToken)
    {
        var result = await UserManagementService.GetAppSubRolesAsync(
            state.Page + 1,
            state.PageSize,
            searchStringAppSubRole
        );
        return new TableData<AppSubRolesDTO>
        {
            TotalItems = (int)result.Count,
            Items = result.Data
        };
    }

    // Add and Edit Dialog
    private async Task OpenAddApplicationDialog()
     => await OpenAddDialog<AddApplicationComponent, AddApplicationDTO>("Add Application", AddApplication);

    private async Task OpenAddSubMenuDialog()
     => await OpenAddDialog<AddSubMenuComponent, AddSubMenuDTO>("Add SubMenu", AddSubMenu);

    private async Task OpenAddRoleDialog()
        => await OpenAddDialog<AddRoleComponent, AddRoleDTO>("Add Role", AddRole);

    private async Task OpenAddAppSubRoleDialog()
    {
        await OpenAddDialog<AddAppSubRoleComponent, AddAppSubRoleResult>(
            "Add User's AppSubRole",
            async result =>
            {
                var appSubRoleDto = result.AppSubRole;
                var notificationDto = result.Notification;

                await AddAppSubRole(appSubRoleDto);
                await UserManagementService.SendNotificationAsync(notificationDto);
            });
    }

    private async Task OpenEditUserApprovalDialog(UnApprovedUsersDTO unapproveduser)
    {
        await OpenEditDialog<EditUserApprovalComponent, UnApprovedUsersDTO>("User Approval", "User", unapproveduser, async result =>
        {
            await EditUser(unapproveduser);
            await UserManagementService.SendApprovalNotificationAsync(unapproveduser.email!);
        });
    }
    private async Task OpenEditApplicationDialog(ApplicationsDTO app)
      => await OpenEditDialog<EditApplicationComponent, ApplicationsDTO>("Edit Application", "Application", app, EditApplication);

    private async Task OpenEditSubMenuDialog(SubMenusDTO sub)
        => await OpenEditDialog<EditSubMenuComponent, SubMenusDTO>("Edit SubMenu", "SubMenu", sub, EditSubMenu);

    private async Task OpenEditRoleDialog(RolesDTO role)
        => await OpenEditDialog<EditRoleComponent, RolesDTO>("Edit Role", "Role", role, EditRole);

    private async Task OpenEditAppSubRoleDialog(AppSubRolesDTO appsubrole)
        => await OpenEditDialog<EditAppSubRoleComponent, AppSubRolesDTO>("Edit UserAppSubRole", "AppSubRole", appsubrole, EditAppSubRole);

    // Delete Dialog
    private async Task ConfirmDelete(int id, string table)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to delete this {table}?" },
            { "ButtonText", "Delete" }
        };

        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<DeleteDialogConfirmation>("Confirm Delete", parameters, options)!;
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            switch (table)
            {
                case "application":
                    await DeleteApplication(id);
                    break;
                case "submenu":
                    await DeleteSubMenu(id);
                    break;
                case "role":
                    await DeleteRole(id);
                    break;
                case "appsubrole":
                    await DeleteAppSubRole(id);
                    break;
            }
        }
    }

    private async Task ConfirmUnlockAccount(Guid id)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to unlock this account?" },
            { "ButtonText", "Unlock" }
        };

        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<DeleteDialogConfirmation>("Unlocking User Account", parameters, options)!;
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
           await DeleteLockedUser(id);
        }
    }

    // Command Execution 
    private async Task DeleteApplication(int AppId)
    {
        await UserManagementService.DeleteApplicationAsync(AppId);
        await applicationsTable.TableRef.ReloadServerData();
        return;
    }

    private async Task DeleteSubMenu(int SubMenuId)
    {
        await UserManagementService.DeleteSubMenuAsync(SubMenuId);
        await subMenusTable.TableRef.ReloadServerData();
        return;
    }

    private async Task DeleteRole(int RoleId)
    {
        await UserManagementService.DeleteRoleAsync(RoleId);
        await rolesTable.TableRef.ReloadServerData();
        return;
    }

    private async Task DeleteAppSubRole(int AppSubRoleId)
    {
        await UserManagementService.DeleteUserAppSubRoleAsync(AppSubRoleId);
        await appSubRolesTable.TableRef.ReloadServerData();
        return;
    }

    private async Task DeleteLockedUser(Guid lockedUserId)
    {
        await UserManagementService.DeleteLockedUserAsync(lockedUserId);
        await lockedUsersTable.TableRef.ReloadServerData();
        return;
    }

    private async Task AddApplication(AddApplicationDTO addApplicationDTO)
    {
        await UserManagementService.AddApplicationAsync(addApplicationDTO);
        await applicationsTable.TableRef.ReloadServerData();
        return;
    }

    private async Task AddSubMenu(AddSubMenuDTO addSubMenuDTO)
    {
        await UserManagementService.AddSubMenuAsync(addSubMenuDTO);
        await subMenusTable.TableRef.ReloadServerData();
        return;
    }

    private async Task AddRole(AddRoleDTO addRoleDTO)
    {
        await UserManagementService.AddRoleAsync(addRoleDTO);
        await rolesTable.TableRef.ReloadServerData();
        return;
    }

    private async Task AddAppSubRole(AddAppSubRoleDTO addAppSubRoleDTO)
    {
        await UserManagementService.AddAppSubRoleAsync(addAppSubRoleDTO);
        await appSubRolesTable.TableRef.ReloadServerData();
        return;
    }

    private async Task EditUser(UnApprovedUsersDTO editUserDTO)
    {
        await UserManagementService.EditUserAsync(editUserDTO);
        await unapprovedUsersTable.TableRef.ReloadServerData();
        StateHasChanged();
        return;
    }

    private async Task EditApplication(ApplicationsDTO editApplicationDTO)
    {
        await UserManagementService.EditApplicationAsync(editApplicationDTO);
        await applicationsTable.TableRef.ReloadServerData();
        StateHasChanged();
        return;
    }

    private async Task EditSubMenu(SubMenusDTO editSubMenuDTO)
    {
        await UserManagementService.EditSubMenuAsync(editSubMenuDTO);
        await subMenusTable.TableRef.ReloadServerData();
        return;
    }

    private async Task EditRole(RolesDTO editRoleDTO)
    {
        await UserManagementService.EditRoleAsync(editRoleDTO);
        await rolesTable.TableRef.ReloadServerData();
        return;
    }

    private async Task EditAppSubRole(AppSubRolesDTO editAppSubRoleDTO)
    {
        await UserManagementService.EditAppSubRoleAsync(editAppSubRoleDTO);
        await appSubRolesTable.TableRef.ReloadServerData();
        return;
    }
}

