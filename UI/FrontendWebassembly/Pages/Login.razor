@page "/login"
@using FrontendWebassembly.DTO.Auth
@using MudBlazor
@layout AuthLayout
@inject NavigationManager Navigation
@inject IAuthService IAuthService

<style>
    .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
    }

    .login-card {
        width: 100%;
        max-width: 450px;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 24px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
    }

    .login-header {
        text-align: center;
        padding: 40px 40px 20px 40px;
    }

    .login-logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    }

    .login-body {
        padding: 0 40px 40px 40px;
    }

    .login-title {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 8px;
    }

    .login-subtitle {
        color: #64748b;
        font-size: 14px;
    }

    .mud-input-root {
        border-radius: 12px !important;
    }

    .login-button {
        border-radius: 12px !important;
        height: 48px !important;
        font-weight: 600 !important;
        text-transform: none !important;
        font-size: 16px !important;
    }

    .divider-text {
        display: flex;
        align-items: center;
        text-align: center;
        color: #94a3b8;
        margin: 24px 0;
    }

        .divider-text::before,
        .divider-text::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e2e8f0;
        }

        .divider-text span {
            padding: 0 12px;
            font-size: 14px;
        }

    .footer-links {
        text-align: center;
        margin-top: 24px;
        color: #64748b;
        font-size: 14px;
    }

        .footer-links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

            .footer-links a:hover {
                text-decoration: underline;
            }
</style>

<div class="login-container">
    <MudPaper Class="login-card" Elevation="0">
        <div class="login-header">
            <div class="login-logo">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Style="color: white;" />
            </div>
            <div class="login-title">One Platform</div>
            <div class="login-subtitle">Sign in to your account to continue</div>
        </div>

        <div class="login-body">

            @if (!isUserVald)
            {
                <MudAlert Severity="Severity.Error" Elevation="0" Variant="Variant.Filled" Class="mb-4">
                    Invalid username or password.
                </MudAlert>
            }

            <MudForm @ref="form" @bind-IsValid="@success">
                <MudTextField @bind-Value="username"
                              Label="Username"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Required="true"
                              RequiredError="Username is required"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Person"
                              Class="mb-4" />

                <MudTextField @bind-Value="password"
                              Label="Password"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Required="true"
                              RequiredError="Password is required"
                              InputType="@passwordInput"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@passwordIcon"
                              OnAdornmentClick="TogglePasswordVisibility"
                              AdornmentAriaLabel="Show Password"
                              Class="mb-3" />

                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudCheckBox @bind-Value="rememberMe" Label="Remember me" Color="Color.Primary" Dense="true" />
                    <MudLink Href="/forgot-password" Color="Color.Primary" Typo="Typo.body2">Forgot password?</MudLink>
                </MudStack>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Class="login-button"
                           OnClick="HandleLogin"
                           Disabled="@(!success || isLoading)">
                    @if (isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    }
                    else
                    {
                        <span>Sign In</span>
                    }
                </MudButton>
            </MudForm>

            <div class="footer-links">
                Don't have an account? <a href="/register">Sign up</a>
            </div>
        </div>
    </MudPaper>
</div>

@code {
    private MudForm form;
    private bool success;
    private bool isLoading = false;
    private string username = "";
    private string password = "";
    private bool rememberMe = false;
    private bool isUserVald = true;
    private string errorMessage = "";

    private bool isPasswordVisible = false;
    private InputType passwordInput = InputType.Password;
    private string passwordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        if (isPasswordVisible)
        {
            isPasswordVisible = false;
            passwordInput = InputType.Password;
            passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            isPasswordVisible = true;
            passwordInput = InputType.Text;
            passwordIcon = Icons.Material.Filled.Visibility;
        }
    }

    private async Task HandleLogin()
    {
        isLoading = true;

        var userData = await IAuthService.Login(new LoginCred(username, password));

        if (userData.detail is not null || !string.IsNullOrEmpty(userData.errorMessage))
        {
            isLoading = false;
            isUserVald = false;
            errorMessage = userData!.detail;
            StateHasChanged();
            return;
        }
       else
        {
            
        Navigation.NavigateTo("/", true);
        }

    }
}