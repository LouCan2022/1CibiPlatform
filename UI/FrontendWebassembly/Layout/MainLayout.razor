@using MudBlazor

@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject IAuthService IAuthService
@inject LocalStorageService LocalStorageService

<style>
    .mud-drawer {
        border-radius: 30px 30px 30px 30px !important;
    }

    .mud-drawer.mud-drawer-open {
        border-radius: 30px 30px 30px 30px !important;
    }

    .mud-appbar {
        border-radius: 30px 30px 30px 30px !important;
    }

    .mud-nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
    }
</style>

<MudThemeProvider Theme="@_myTheme" @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
@if (_isAuthenticated)
{
<ErrorBoundary>
    <ChildContent>
            <MudLayout>
                <!-- AppBar -->
                <MudAppBar Style="@GetAppBarStyle()">
                    <MudIconButton Icon="@Icons.Material.Filled.Menu" Style="@GetMenuIconStyle()" Edge="Edge.Start" OnClick="@DrawerToggle" />
                    <MudSpacer />
                    <MudIconButton Icon="@(_isDarkMode? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                                   Style="Color.Inherit"
                                   OnClick="ToggleDarkMode" />
                </MudAppBar>
                <!-- Drawer -->
                <MudDrawer @bind-Open="_drawerOpen"
                           Elevation="1"
                           Style="box-shadow: 0 0 30px rgba(0, 0, 0, 0.25); border-radius: 8px; display: flex; flex-direction: column;">
                    <MudDrawerHeader Style="display: flex; justify-content: center; align-items: center;
                    background: white;">
                        <MudImage Src="images/logo/cibi.png"
                                  Alt="Cibi Logo"
                                  Style="width: 125px; height:45px;" />
                    </MudDrawerHeader>

                    <!-- Navigation menu that fills remaining space -->
                    <MudNavMenu Class="flex-grow-1">
                        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                        <MudNavGroup Title="Philsys" Expanded="false" Icon="@Icons.Material.Filled.Flag">
                            <MudNavLink Href="philsys" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">IDV</MudNavLink>
                        </MudNavGroup>
                        <MudNavGroup Title="CNX" Expanded="false" Icon="@Icons.Material.Filled.Call">
                            <MudNavLink Href="cnx" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Search">Search Candidate</MudNavLink>
                        </MudNavGroup>
                    </MudNavMenu>

                    <!-- Logout at the very bottom -->
                    <div class="px-4 py-2 mt-auto">
                        <MudNavLink Icon="@Icons.Material.Filled.Logout"
                                    Match="NavLinkMatch.All"
                                    OnClick="HandleLogout">
                            Logout
                        </MudNavLink>
                    </div>

                </MudDrawer>
                <!-- Main content -->
                <MudMainContent>
                    <MudPaper Class="pa-5 ma-5" Elevation="2">
                        @Body
                    </MudPaper>
                </MudMainContent>
            </MudLayout>
 
    </ChildContent>
    <ErrorContent Context="exception">
        <MudContainer Class="d-flex flex-column justify-center align-center" Style="height: 100vh; gap: 20px;">
            <MudPaper Class="pa-8" Elevation="3" Style="max-width: 600px; text-align: center;">
                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" Class="mb-4" />
                <MudText Typo="Typo.h4" Color="Color.Error" Class="mb-2">
                    Oops! Something went wrong
                </MudText>
                <MudText Typo="Typo.body1" Class="mb-4">
                    We encountered an unexpected error. Please try refreshing the page.
                </MudText>
                <MudExpansionPanels>
                    <MudExpansionPanel Text="Error Details">
                        <MudText Typo="Typo.body2" Style="font-family: monospace; white-space: pre-wrap; word-break: break-word;">
                            @exception.Message
                        </MudText>
                    </MudExpansionPanel>
                </MudExpansionPanels>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="@(() => Navigation.NavigateTo(Navigation.Uri, true))"
                           StartIcon="@Icons.Material.Filled.Refresh"
                           Class="mt-4">
                    Reload Page
                </MudButton>
            </MudPaper>
        </MudContainer>
    </ErrorContent>
</ErrorBoundary>

}
else
{
    <!-- Loading -->
    <MudContainer Class="d-flex justify-center align-center" Style="height: 100vh;">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
    </MudContainer>
}

@code {


    private bool _isDarkModeLoaded = false;
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private bool _isAuthenticated = false;

    private MudTheme _myTheme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#667eea",
            Secondary = "#764ba2",
            Background = Colors.Gray.Lighten5,
            Surface = Colors.Shades.White,
            AppbarBackground = "#667eea",
            AppbarText = Colors.Shades.White,
            TextPrimary = Colors.Gray.Darken3
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#8b9dff",
            Secondary = "#9d6bc7",
            Background = Colors.Gray.Darken4,
            Surface = Colors.Gray.Darken3,
            AppbarBackground = "#5568d3",
            AppbarText = Colors.Shades.White,
            TextPrimary = Colors.Shades.White
        },
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "30px",
            DrawerWidthLeft = "260px",
            DrawerWidthRight = "260px",
            AppbarHeight = "64px"
        }
    };

    private void DrawerToggle() => _drawerOpen = !_drawerOpen;
    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        await LocalStorageService.SetItemAsync("isDarkMode", _isDarkMode);
    }

    private string GetAppBarStyle()
    {
        return _isDarkMode
            ? "background: linear-gradient(90deg, #68c0d6 0%, #2a77ae 50%, #102247 100%) !important;"
            : "background: linear-gradient(90deg, #102247 0%, #2a77ae 50%, #68c0d6 100%) !important;";
    }
    private string GetMenuIconStyle()
    {
        return _isDarkMode
            ? "color: #102247;"   
            : "color: white;";    
    }
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var stored = await LocalStorageService.GetItemAsync<bool?>("isDarkMode");
            _isDarkMode = stored ?? false;
      
            var isAuthenticated = await IAuthService.IsAuthenticated();

            if (!isAuthenticated)
            {
                Navigation.NavigateTo("/login", true);
            }

            _isAuthenticated = isAuthenticated;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Authentication Error: {ex.Message}");
            throw;
        }
    }
    private async Task HandleLogout()
    {
        Console.WriteLine("Logging out...");

        try
        {
            var logout = await IAuthService.Logout();


            if (logout)
            {
                Console.WriteLine(logout ? "Logout successful." : "Logout failed.");
                Navigation.NavigateTo("/login", true);
            }
        }
        catch (Exception ex)
        {
            _isAuthenticated = true;
            Console.WriteLine($"Authentication Error: {ex.Message}");
            throw;
        }


    }
 
}